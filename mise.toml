[settings]
experimental = true

[tools]
gitleaks = "latest"
hk = "latest"
pkl = "latest"

[tasks.test]
description = "Test dotfiles in a fresh Docker container using local source"
run = """
# Get GitHub token from gh CLI if available (avoids rate limits)
GITHUB_TOKEN="${GITHUB_TOKEN:-$(gh auth token 2>/dev/null || echo '')}"

docker run --rm \
  -v "$PWD:/dotfiles:ro" \
  -e DEBIAN_FRONTEND=noninteractive \
  -e GITHUB_TOKEN="$GITHUB_TOKEN" \
  ubuntu:latest \
  bash -c "
    set -e
    echo 'ðŸ§ª Setting up test environment...'
    apt-get update -qq 2>&1 > /dev/null
    apt-get install -y -qq apt-utils 2>&1 > /dev/null
    apt-get install -y -qq curl git sudo 2>&1 > /dev/null
    useradd -m -s /bin/bash testuser
    echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
    echo
    su - testuser -c 'GITHUB_TOKEN=$GITHUB_TOKEN bash /dotfiles/test.sh'
  "
"""

[hooks]
postinstall = "hk install --mise"
