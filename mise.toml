[settings]
experimental = true

[tools]
gitleaks = "latest"
hk = "latest"
pkl = "latest"

# =============================================================================
# Bootstrap Tasks
# =============================================================================

[tasks.bootstrap]
description = "Bootstrap environment"
depends = ["brew-core", "mise-tools", "fish-default"]
usage = 'flag "--full" help="Include personal Homebrew packages"'
shell = "bash -c"
run = """
[[ "$usage_full" == "true" ]] && mise run brew-personal
echo 'âœ… Bootstrap complete'
"""

[tasks.brew-core]
description = "Install core Homebrew packages (macOS only)"
depends = ["chezmoi-apply"]
shell = "bash -c"
run = """
[[ "$(uname)" != "Darwin" ]] && exit 0
if ! command -v brew &>/dev/null; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || /usr/local/bin/brew shellenv)"
fi
brew bundle --file=~/.Brewfile.core
"""

[tasks.brew-personal]
description = "Install personal Homebrew packages (macOS only)"
depends = ["chezmoi-apply"]
shell = "bash -c"
run = """
[[ "$(uname)" != "Darwin" ]] && exit 0
brew bundle --file=~/.Brewfile.personal
"""

[tasks.chezmoi-apply]
description = "Apply chezmoi dotfiles"
shell = "bash -c"
run = """
if ! command -v chezmoi &>/dev/null; then
  echo "Installing chezmoi..."
  curl -fsLS get.chezmoi.io | sh
fi
EXCLUDE=""
[[ "$(uname)" != "Darwin" ]] && EXCLUDE="--exclude=encrypted"
if [ -d "$HOME/.local/share/chezmoi/.git" ]; then
  chezmoi apply $EXCLUDE
else
  chezmoi init --apply jkp $EXCLUDE
fi
"""

[tasks.mise-tools]
description = "Install global mise tools"
dir = "~"
run = "$HOME/.local/bin/mise install"

[tasks.fish-default]
description = "Set fish as default shell"
shell = "bash -c"
run = """
if [[ "$SHELL" != *fish* ]]; then
  fish_path=$(command -v fish)
  if [ -n "$fish_path" ]; then
    if ! grep -q "$fish_path" /etc/shells 2>/dev/null; then
      echo "$fish_path" | sudo tee -a /etc/shells > /dev/null
    fi
    sudo chsh -s "$fish_path" "$USER"
    echo "Fish set as default shell"
  fi
fi
"""

# =============================================================================
# Verification Tasks
# =============================================================================

[tasks.verify]
description = "Verify system state"
env = { HOMEBREW_NO_AUTO_UPDATE = "1" }
run = """
set -e
echo "ðŸ” Verifying system state..."

if [[ "$(uname)" == "Darwin" ]]; then
  echo
  echo "Homebrew packages:"
  brew bundle check --file=~/.Brewfile.core 2>/dev/null && echo "  âœ“ Core packages" || echo "  âœ— Core packages missing"
  brew bundle check --file=~/.Brewfile.personal 2>/dev/null && echo "  âœ“ Personal packages" || echo "  âš  Personal packages (optional)"
fi

echo
echo "Mise tools:"
for tool in bat fd rg jq zoxide nvim; do
  command -v $tool &>/dev/null && echo "  âœ“ $tool" || echo "  âœ— $tool"
done

echo
echo "Fish functions:"
fish --no-config -c 'source ~/.config/fish/functions/chezmoi-check.fish 2>/dev/null && echo "  âœ“ chezmoi-check" || echo "  âœ— chezmoi-check"'
fish --no-config -c 'source ~/.config/fish/functions/chezmoi-commit.fish 2>/dev/null && echo "  âœ“ chezmoi-commit" || echo "  âœ— chezmoi-commit"'

echo
echo "âœ… Verification complete"
"""

[tasks.doctor]
description = "Diagnose environment issues"
run = """
echo "ðŸ©º Diagnosing environment..."
echo

# Core tools
echo "Core tools:"
command -v brew &>/dev/null && echo "  âœ“ Homebrew" || echo "  âœ— Homebrew"
command -v fish &>/dev/null && echo "  âœ“ Fish" || echo "  âœ— Fish"
command -v chezmoi &>/dev/null && echo "  âœ“ Chezmoi" || echo "  âœ— Chezmoi"
command -v mise &>/dev/null && echo "  âœ“ Mise" || echo "  âœ— Mise"

# Shell
echo
echo "Shell:"
echo "  Current: $SHELL"
echo "  Fish path: $(command -v fish 2>/dev/null || echo 'not found')"

# Chezmoi state
echo
echo "Chezmoi:"
if [ -d "$HOME/.local/share/chezmoi" ]; then
  echo "  âœ“ Initialized"
  chezmoi status 2>/dev/null | head -5 || echo "  (no drift)"
else
  echo "  âœ— Not initialized"
fi

# Mise
echo
echo "Mise:"
mise doctor 2>&1 | grep -E "(version|error|warning)" | head -5 || echo "  âœ“ Healthy"
"""

# =============================================================================
# Testing
# =============================================================================

[tasks.test]
description = "Test dotfiles in a fresh Docker container"
sources = ["dot_*/**", "bootstrap.sh", "test.sh", "mise.toml", "hk.pkl"]
outputs = [".test-ok"]
env = { DEBIAN_FRONTEND = "noninteractive" }
run = """
GITHUB_TOKEN="${GITHUB_TOKEN:-$(gh auth token 2>/dev/null || echo '')}"

docker run --rm \
  -v "$PWD:/dotfiles:ro" \
  -e DEBIAN_FRONTEND \
  -e GITHUB_TOKEN="$GITHUB_TOKEN" \
  ubuntu:latest \
  bash -c "
    set -e
    echo 'ðŸ§ª Setting up test environment...'
    apt-get update -qq 2>&1 > /dev/null
    apt-get install -y -qq apt-utils 2>&1 > /dev/null
    apt-get install -y -qq curl git sudo 2>&1 > /dev/null
    useradd -m -s /bin/bash testuser
    echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
    echo
    # Pass GITHUB_TOKEN to testuser with correct HOME
    su testuser -c \\\"HOME=/home/testuser GITHUB_TOKEN=$GITHUB_TOKEN bash /dotfiles/test.sh\\\"
  "
touch .test-ok
"""

[hooks]
# Only run hk install in git repos that don't already have hooks
postinstall = "[ -d .git ] && [ ! -f .git/hooks/pre-commit ] && mise exec -- hk install --mise || true"
