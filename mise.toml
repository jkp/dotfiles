[settings]
experimental = true

[tools]
gitleaks = "latest"
hk = "latest"
pkl = "latest"

[tasks.test-bootstrap]
description = "Test bootstrap in a fresh Docker container using local dotfiles"
run = """
docker run --rm \
  -v "$PWD:/dotfiles:ro" \
  -e DEBIAN_FRONTEND=noninteractive \
  ubuntu:latest \
  bash -c "
    set -e
    echo 'üß™ Setting up test environment...'
    apt-get update -qq 2>&1 > /dev/null
    apt-get install -y -qq apt-utils 2>&1 > /dev/null
    apt-get install -y -qq curl git sudo 2>&1 > /dev/null
    useradd -m -s /bin/bash testuser
    echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
    echo
    su - testuser -c '
      set -e
      export PATH=\\$HOME/bin:\\$HOME/.local/bin:\\$PATH
      export DEBIAN_FRONTEND=noninteractive
      export DOTFILES_SOURCE=/dotfiles

      # Run bootstrap script with local source
      bash /dotfiles/bootstrap.sh

      echo
      echo \\\"‚úÖ First bootstrap completed successfully!\\\"
      echo

      # Test idempotency - run again
      echo \\\"üîÑ Testing idempotency - running bootstrap again...\\\"
      bash /dotfiles/bootstrap.sh

      echo
      echo \\\"‚úÖ Bootstrap test completed successfully!\\\"
      echo \\\"‚úÖ Git hooks installed:\\\"
      ls -la ~/.local/share/chezmoi/.git/hooks/pre-commit 2>&1 | grep pre-commit || echo \\\"  ‚ùå No hooks found\\\"
    ' || exit 1
  "
"""

[hooks]
postinstall = "hk install --mise"
